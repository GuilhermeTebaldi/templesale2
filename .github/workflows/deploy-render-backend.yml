name: Deploy Render Backend

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: render-backend-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Trigger Render deploy hook
        env:
          RENDER_DEPLOY_HOOK_URL_SECRET: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          RENDER_DEPLOY_HOOK_URL_VAR: ${{ vars.RENDER_DEPLOY_HOOK_URL }}
        run: |
          set -euo pipefail

          RENDER_DEPLOY_HOOK_URL="${RENDER_DEPLOY_HOOK_URL_SECRET:-${RENDER_DEPLOY_HOOK_URL_VAR:-}}"

          if [ -z "${RENDER_DEPLOY_HOOK_URL:-}" ]; then
            echo "Missing configuration: set RENDER_DEPLOY_HOOK_URL in repo Secrets or Variables."
            exit 1
          fi

          attempts=0
          max_attempts=3
          while [ "$attempts" -lt "$max_attempts" ]; do
            attempts=$((attempts + 1))
            echo "Triggering Render deploy hook (attempt ${attempts}/${max_attempts})..."

            http_code="$(curl --silent --show-error \
              --output /tmp/render-deploy-hook-response.json \
              --write-out '%{http_code}' \
              -X POST \
              "$RENDER_DEPLOY_HOOK_URL" || true)"

            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "Render deploy hook triggered successfully (HTTP ${http_code})."
              echo "Render response:"
              cat /tmp/render-deploy-hook-response.json
              exit 0
            fi

            echo "Render deploy hook failed with HTTP ${http_code}."
            echo "Response body:"
            cat /tmp/render-deploy-hook-response.json || true

            if [ "$attempts" -lt "$max_attempts" ]; then
              sleep 5
            fi
          done

          echo "Failed to trigger Render deploy hook after ${max_attempts} attempts."
          exit 1
